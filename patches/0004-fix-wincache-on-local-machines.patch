From 0ce55b8f079581e08477821fc4d19917070f156c Mon Sep 17 00:00:00 2001
From: Johannes Goslar <johannes.goslar@dkd.de>
Date: Tue, 25 Aug 2015 16:42:47 +0200
Subject: [PATCH 4/6] fix wincache on local machines

---
 .../core/Classes/Service/OpcodeCacheService.php    |  7 +------
 typo3conf/AdditionalConfiguration.php              | 23 +++++++++++++++++++++-
 2 files changed, 23 insertions(+), 7 deletions(-)

diff --git a/typo3/sysext/core/Classes/Service/OpcodeCacheService.php b/typo3/sysext/core/Classes/Service/OpcodeCacheService.php
index 714250b..1142a57 100644
--- a/typo3/sysext/core/Classes/Service/OpcodeCacheService.php
+++ b/typo3/sysext/core/Classes/Service/OpcodeCacheService.php
@@ -59,12 +59,7 @@ class OpcodeCacheService {
 				'canInvalidate' => TRUE, // wincache_refresh_if_changed()
 				'error' => FALSE,
 				'clearCallback' => function ($fileAbsPath) {
-					if ($fileAbsPath !== NULL) {
-						wincache_refresh_if_changed(array($fileAbsPath));
-					} else {
-						// No argument means refreshing all.
-						wincache_refresh_if_changed();
-					}
+					wincache_refresh_if_changed();
 				}
 			),
 
diff --git a/typo3conf/AdditionalConfiguration.php b/typo3conf/AdditionalConfiguration.php
index 269cb19..1a7ad35 100644
--- a/typo3conf/AdditionalConfiguration.php
+++ b/typo3conf/AdditionalConfiguration.php
@@ -10,4 +10,25 @@ $GLOBALS['TYPO3_CONF_VARS']['SYS']['setDBinit'] = "SET SESSION sql_mode='';";
 //set to flock as simple can have problems on azure
 $GLOBALS['TYPO3_CONF_VARS']['SYS']['lockingMode'] = 'flock';
 
-$GLOBALS['TYPO3_CONF_VARS']['EXTCONF']['rtehtmlarea']['defaultConfiguration'] = 'typical';
\ No newline at end of file
+$GLOBALS['TYPO3_CONF_VARS']['EXTCONF']['rtehtmlarea']['defaultConfiguration'] = 'typical';
+
+//fix openssl config path
+putenv("OPENSSL_CONF=" . dirname(__FILE__) . "\openssl.cnf");
+
+$types = array(
+ "cache_hash",
+ "cache_pages",
+ "cache_pagesection",
+ "cache_rootline",
+ "cache_imagesizes",
+ "cache_l10n",
+ "extbase_object",
+ "extbase_reflection",
+ "extbase_typo3dbbackend_tablecolumns",
+ "extbase_typo3dbbackend_queries",
+ "extbase_datamapfactory_datamap",
+);
+foreach ($types as $ct) {
+    $GLOBALS['TYPO3_CONF_VARS']['SYS']['caching']['cacheConfigurations'][$ct]['backend'] = 'TYPO3\\CMS\\Core\\Cache\\Backend\\WincacheBackend';
+    $GLOBALS['TYPO3_CONF_VARS']['SYS']['caching']['cacheConfigurations'][$ct]['options'] = array();
+};
-- 
1.9.4.msysgit.1

